<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>S3 Extended with S4 Features • R7</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="bootstrap-toc.css">
<script src="bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="pkgdown.css" rel="stylesheet">
<script src="pkgdown.js"></script><meta property="og:title" content="S3 Extended with S4 Features">
<meta property="og:description" content="Prototype implementation of an extension to S3 that
    provides explicit class definitions and a form of multiple dispatch.
    Represents the output of the Object-oriented Programming Working
    Group, sponsored by the R Consortium.">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-home">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="index.html">R7</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="articles/case_studies.html">case_studies</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="contents col-md-9">
<div id="object-oriented-programming-working-group" class="section level1">
<div class="page-header"><h1 class="hasAnchor">
<a href="#object-oriented-programming-working-group" class="anchor"></a>Object-oriented Programming Working Group</h1></div>
<ul>
<li><a href="proposal/proposal.org">Initial proposal</a></li>
<li><a href="spec/requirements.html">Requirements brainstorming</a></li>
<li><a href="minutes/">Minutes</a></li>
<li>
<a href="R/">Code</a> (this repository is an R package)</li>
</ul>
<p>These ideas have been implemented in the R7 package, hosted in this repository.</p>
<!-- badges: start -->
<p><a href="https://github.com/RConsortium/OOP-WG/actions"><img src="https://github.com/RConsortium/OOP-WG/workflows/R-CMD-check/badge.svg" alt="R-CMD-check"></a> <a href="https://codecov.io/gh/RConsortium/OOP-WG?branch=master"><img src="https://codecov.io/gh/RConsortium/OOP-WG/branch/master/graph/badge.svg" alt="Codecov test coverage"></a> <!-- badges: end --></p>
<div id="classes-and-objects" class="section level2">
<h2 class="hasAnchor">
<a href="#classes-and-objects" class="anchor"></a>Classes and objects</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://RConsortium.github.io/OOP-WG">R7</a></span><span class="op">)</span>

<span class="va">range</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/new_class.html">new_class</a></span><span class="op">(</span><span class="st">"range"</span>,
  constructor <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">start</span>, <span class="va">end</span><span class="op">)</span> <span class="op">{</span>
    <span class="fu"><a href="reference/new_object.html">new_object</a></span><span class="op">(</span>start <span class="op">=</span> <span class="va">start</span>, end <span class="op">=</span> <span class="va">end</span><span class="op">)</span>
  <span class="op">}</span>,
  validator <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
    <span class="kw">if</span> <span class="op">(</span><span class="va">x</span><span class="op">@</span><span class="va">end</span> <span class="op">&lt;</span> <span class="va">x</span><span class="op">@</span><span class="va">start</span><span class="op">)</span> <span class="op">{</span>
      <span class="st">"&lt;range&gt;@end must be greater than or equal to &lt;range&gt;@start"</span>
    <span class="op">}</span>
  <span class="op">}</span>,
  properties <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    start <span class="op">=</span> <span class="st">"numeric"</span>,
    end <span class="op">=</span> <span class="st">"numeric"</span>,
    <span class="fu"><a href="reference/new_property.html">new_property</a></span><span class="op">(</span>
      name <span class="op">=</span> <span class="st">"length"</span>,
      class <span class="op">=</span> <span class="st">"numeric"</span>,
      getter <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">@</span><span class="va">end</span> <span class="op">-</span> <span class="va">x</span><span class="op">@</span><span class="va">start</span>,
      setter <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">value</span><span class="op">)</span> <span class="op">{</span>
        <span class="va">x</span><span class="op">@</span><span class="va">end</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">@</span><span class="va">start</span> <span class="op">+</span> <span class="va">value</span>
        <span class="va">x</span>
      <span class="op">}</span>
    <span class="op">)</span>
  <span class="op">)</span>
<span class="op">)</span>

<span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html">range</a></span><span class="op">(</span>start <span class="op">=</span> <span class="fl">1</span>, end <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>

<span class="va">x</span><span class="op">@</span><span class="va">start</span>
<span class="co">#&gt; [1] 1</span>

<span class="va">x</span><span class="op">@</span><span class="va">end</span>
<span class="co">#&gt; [1] 10</span>

<span class="va">x</span><span class="op">@</span><span class="va">length</span>
<span class="co">#&gt; [1] 9</span>

<span class="va">x</span><span class="op">@</span><span class="va">length</span> <span class="op">&lt;-</span> <span class="fl">5</span>

<span class="va">x</span><span class="op">@</span><span class="va">length</span>
<span class="co">#&gt; [1] 5</span>

<span class="co"># incorrect properties throws an error</span>
<span class="va">x</span><span class="op">@</span><span class="va">middle</span>
<span class="co">#&gt; Error: Can't find property &lt;range&gt;@middle</span>

<span class="co"># assigning properties verifies the class matches the class of the value</span>
<span class="va">x</span><span class="op">@</span><span class="va">end</span> <span class="op">&lt;-</span> <span class="st">"foo"</span>
<span class="co">#&gt; Error: &lt;range&gt;@end must be of class &lt;numeric&gt;:</span>
<span class="co">#&gt; - `value` is of class &lt;character&gt;</span>

<span class="co"># assigning properties runs the validator</span>
<span class="va">x</span><span class="op">@</span><span class="va">end</span> <span class="op">&lt;-</span> <span class="fl">0</span>
<span class="co">#&gt; Error: Invalid &lt;range&gt; object:</span>
<span class="co">#&gt; - &lt;range&gt;@end must be greater than or equal to &lt;range&gt;@start</span>

<span class="co"># Print methods for both R7_class objects</span>
<span class="fu"><a href="reference/object_class.html">object_class</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
<span class="co">#&gt; &lt;R7_class&gt;</span>
<span class="co">#&gt; @name range</span>
<span class="co">#&gt; @parent &lt;R7_object&gt;</span>
<span class="co">#&gt; @properties</span>
<span class="co">#&gt;  $start  &lt;numeric&gt;</span>
<span class="co">#&gt;  $end    &lt;numeric&gt;</span>
<span class="co">#&gt;  $length &lt;numeric&gt;</span>

<span class="co"># As well as normal R7_objects</span>
<span class="va">x</span>
<span class="co">#&gt; &lt;R7_object&gt; &lt;range&gt;</span>
<span class="co">#&gt; @start  1</span>
<span class="co">#&gt; @end    6</span>
<span class="co">#&gt; @length 5</span>

<span class="co"># Use `.data` to refer to and retrieve the base data type, properties are</span>
<span class="co"># automatically removed, but non-property attributes (such as names) are retained.</span>

<span class="va">text</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/new_class.html">new_class</a></span><span class="op">(</span><span class="st">"text"</span>, parent <span class="op">=</span> <span class="st">"character"</span>, constructor <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">text</span><span class="op">)</span> <span class="fu"><a href="reference/new_object.html">new_object</a></span><span class="op">(</span>.data <span class="op">=</span> <span class="va">text</span><span class="op">)</span><span class="op">)</span>

<span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>foo <span class="op">=</span> <span class="st">"bar"</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">y</span><span class="op">@</span><span class="va">.data</span><span class="op">)</span>
<span class="co">#&gt; [1] "foo"</span></code></pre></div>
</div>
<div id="generics-and-methods" class="section level2">
<h2 class="hasAnchor">
<a href="#generics-and-methods" class="anchor"></a>Generics and methods</h2>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">text</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/new_class.html">new_class</a></span><span class="op">(</span><span class="st">"text"</span>, parent <span class="op">=</span> <span class="st">"character"</span>, constructor <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">text</span><span class="op">)</span> <span class="fu"><a href="reference/new_object.html">new_object</a></span><span class="op">(</span>.data <span class="op">=</span> <span class="va">text</span><span class="op">)</span><span class="op">)</span>

<span class="va">foo</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/new_generic.html">new_generic</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"foo"</span>, signature <span class="op">=</span> <span class="st">"x"</span><span class="op">)</span>

<span class="fu"><a href="reference/method.html">method</a></span><span class="op">(</span><span class="va">foo</span>, <span class="st">"text"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"foo-"</span>, <span class="va">x</span><span class="op">)</span>

<span class="fu">foo</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="st">"hi"</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; [1] "foo-hi"</span></code></pre></div>
</div>
<div id="multiple-dispatch" class="section level2">
<h2 class="hasAnchor">
<a href="#multiple-dispatch" class="anchor"></a>Multiple dispatch</h2>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">number</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/new_class.html">new_class</a></span><span class="op">(</span><span class="st">"number"</span>, parent <span class="op">=</span> <span class="st">"numeric"</span>, constructor <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="reference/new_object.html">new_object</a></span><span class="op">(</span>.data <span class="op">=</span> <span class="va">x</span><span class="op">)</span><span class="op">)</span>

<span class="va">bar</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/new_generic.html">new_generic</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"bar"</span>, signature <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="reference/method.html">method</a></span><span class="op">(</span><span class="va">bar</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"character"</span>, <span class="st">"numeric"</span><span class="op">)</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">...</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"foo-"</span>, <span class="va">x</span>, <span class="st">":"</span>, <span class="va">y</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/grDevices/plotmath.html">bar</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="st">"hi"</span><span class="op">)</span>, <span class="fu">number</span><span class="op">(</span><span class="fl">42</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; [1] "foo-hi:42"</span></code></pre></div>
</div>
<div id="calling-the-next-method" class="section level2">
<h2 class="hasAnchor">
<a href="#calling-the-next-method" class="anchor"></a>Calling the next method</h2>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="reference/method.html">method</a></span><span class="op">(</span><span class="va">bar</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"text"</span>, <span class="st">"number"</span><span class="op">)</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/next_method.html">next_method</a></span><span class="op">(</span><span class="op">)</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"2 "</span>, <span class="va">res</span><span class="op">)</span>
<span class="op">}</span>

<span class="fu"><a href="https://rdrr.io/r/grDevices/plotmath.html">bar</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="st">"hi"</span><span class="op">)</span>, <span class="fu">number</span><span class="op">(</span><span class="fl">42</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; [1] "2 foo-hi:42"</span></code></pre></div>
</div>
<div id="non-standard-evaluation" class="section level2">
<h2 class="hasAnchor">
<a href="#non-standard-evaluation" class="anchor"></a>Non-standard evaluation</h2>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">subset2</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/new_generic.html">new_generic</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"subset"</span>, signature <span class="op">=</span> <span class="st">"x"</span><span class="op">)</span>

<span class="fu"><a href="reference/method.html">method</a></span><span class="op">(</span><span class="va">subset2</span>, <span class="st">"data.frame"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">subset</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">select</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">drop</span> <span class="op">=</span> <span class="cn">FALSE</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">e</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/substitute.html">substitute</a></span><span class="op">(</span><span class="va">subset</span><span class="op">)</span>
  <span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/eval.html">eval</a></span><span class="op">(</span><span class="va">e</span>, <span class="va">x</span>, <span class="fu"><a href="https://rdrr.io/r/base/sys.parent.html">parent.frame</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
  <span class="va">r</span> <span class="op">&lt;-</span> <span class="va">r</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span>
  <span class="va">nl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">as.list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">nl</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
  <span class="va">vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/eval.html">eval</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/substitute.html">substitute</a></span><span class="op">(</span><span class="va">select</span><span class="op">)</span>, <span class="va">nl</span>, <span class="fu"><a href="https://rdrr.io/r/base/sys.parent.html">parent.frame</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
  <span class="va">x</span><span class="op">[</span><span class="va">r</span>, <span class="va">vars</span>, drop <span class="op">=</span> <span class="va">drop</span><span class="op">]</span>
<span class="op">}</span>

<span class="fu">subset2</span><span class="op">(</span><span class="va">mtcars</span>, <span class="va">hp</span> <span class="op">&gt;</span> <span class="fl">200</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">wt</span>, <span class="va">qsec</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt;                        wt  qsec</span>
<span class="co">#&gt; Duster 360          3.570 15.84</span>
<span class="co">#&gt; Cadillac Fleetwood  5.250 17.98</span>
<span class="co">#&gt; Lincoln Continental 5.424 17.82</span>
<span class="co">#&gt; Chrysler Imperial   5.345 17.42</span>
<span class="co">#&gt; Camaro Z28          3.840 15.41</span>
<span class="co">#&gt; Ford Pantera L      3.170 14.50</span>
<span class="co">#&gt; Maserati Bora       3.570 14.60</span></code></pre></div>
<div id="external-generics" class="section level3">
<h3 class="hasAnchor">
<a href="#external-generics" class="anchor"></a>External generics</h3>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">.onLoad</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">libname</span>, <span class="va">pkgname</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu">R7</span><span class="fu">::</span><span class="fu"><a href="reference/method_register.html">method_register</a></span><span class="op">(</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">foo</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/new_generic.html">new_external_generic</a></span><span class="op">(</span><span class="st">"pkg1"</span>, <span class="st">"foo"</span><span class="op">)</span>

<span class="fu"><a href="reference/method.html">method</a></span><span class="op">(</span><span class="va">foo</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"text"</span>, <span class="st">"numeric"</span><span class="op">)</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">...</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"foo-"</span>, <span class="va">x</span>, <span class="st">": "</span>, <span class="va">y</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="performance" class="section level2">
<h2 class="hasAnchor">
<a href="#performance" class="anchor"></a>Performance</h2>
<p>The dispatch performance should be roughly on par with S3 and S4, though as this is implemented in the package there is some overhead due to <code>.Call</code> vs <code>.Primitive</code>.</p>
<p>Dispatch uses a table stored in the <code>methods</code> property of the generic. This table is a nested set of hashed environments based on the classes of the methods. e.g.</p>
<p><code><a href="reference/method.html">method(foo, c("character", "numeric"))</a></code> method would be stored at</p>
<p><code>foo@methods[["character"]][["numeric"]]</code></p>
<p>At each level the search iteratively searches up the class vector for the object.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">text</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/new_class.html">new_class</a></span><span class="op">(</span><span class="st">"text"</span>, parent <span class="op">=</span> <span class="st">"character"</span>, constructor <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">text</span><span class="op">)</span> <span class="fu"><a href="reference/new_object.html">new_object</a></span><span class="op">(</span>.data <span class="op">=</span> <span class="va">text</span><span class="op">)</span><span class="op">)</span>
<span class="va">number</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/new_class.html">new_class</a></span><span class="op">(</span><span class="st">"number"</span>, parent <span class="op">=</span> <span class="st">"numeric"</span>, constructor <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="reference/new_object.html">new_object</a></span><span class="op">(</span>.data <span class="op">=</span> <span class="va">x</span><span class="op">)</span><span class="op">)</span>

<span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="st">"hi"</span><span class="op">)</span>
<span class="va">y</span> <span class="op">&lt;-</span> <span class="fu">number</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>

<span class="va">foo_R7</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/new_generic.html">new_generic</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"foo_R7"</span>, signature <span class="op">=</span> <span class="st">"x"</span><span class="op">)</span>
<span class="fu"><a href="reference/method.html">method</a></span><span class="op">(</span><span class="va">foo_R7</span>, <span class="st">"text"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"-foo"</span><span class="op">)</span>

<span class="va">foo_s3</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/UseMethod.html">UseMethod</a></span><span class="op">(</span><span class="st">"foo_s3"</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">foo_s3.text</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"-foo"</span><span class="op">)</span>
<span class="op">}</span>

<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">methods</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/methods/setOldClass.html">setOldClass</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"number"</span>, <span class="st">"numeric"</span>, <span class="st">"R7_object"</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/methods/setOldClass.html">setOldClass</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"text"</span>, <span class="st">"character"</span>, <span class="st">"R7_object"</span><span class="op">)</span><span class="op">)</span>

<span class="kw"><a href="https://rdrr.io/r/methods/setGeneric.html">setGeneric</a></span><span class="op">(</span><span class="st">"foo_s4"</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/standardGeneric.html">standardGeneric</a></span><span class="op">(</span><span class="st">"foo_s4"</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; [1] "foo_s4"</span>
<span class="kw"><a href="https://rdrr.io/r/methods/setMethod.html">setMethod</a></span><span class="op">(</span><span class="st">"foo_s4"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"text"</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"-foo"</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Measure performance of single dispatch</span>
<span class="fu">bench</span><span class="fu">::</span><span class="fu">mark</span><span class="op">(</span><span class="fu">foo_R7</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="fu">foo_s3</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="fu">foo_s4</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 3 x 6</span>
<span class="co">#&gt;   expression      min   median `itr/sec` mem_alloc `gc/sec`</span>
<span class="co">#&gt;   &lt;bch:expr&gt; &lt;bch:tm&gt; &lt;bch:tm&gt;     &lt;dbl&gt; &lt;bch:byt&gt;    &lt;dbl&gt;</span>
<span class="co">#&gt; 1 foo_R7(x)    8.73µs  10.04µs    79858.        0B     16.0</span>
<span class="co">#&gt; 2 foo_s3(x)    4.03µs   4.44µs   218175.        0B      0  </span>
<span class="co">#&gt; 3 foo_s4(x)    4.22µs    4.6µs   200374.        0B     20.0</span>

<span class="va">bar_R7</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/new_generic.html">new_generic</a></span><span class="op">(</span><span class="st">"bar_R7"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="reference/method.html">method</a></span><span class="op">(</span><span class="va">bar_R7</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"text"</span>, <span class="st">"number"</span><span class="op">)</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">...</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"-"</span>, <span class="va">y</span>, <span class="st">"-bar"</span><span class="op">)</span>

<span class="kw"><a href="https://rdrr.io/r/methods/setGeneric.html">setGeneric</a></span><span class="op">(</span><span class="st">"bar_s4"</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">...</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/standardGeneric.html">standardGeneric</a></span><span class="op">(</span><span class="st">"bar_s4"</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; [1] "bar_s4"</span>
<span class="kw"><a href="https://rdrr.io/r/methods/setMethod.html">setMethod</a></span><span class="op">(</span><span class="st">"bar_s4"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"text"</span>, <span class="st">"number"</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">...</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"-"</span>, <span class="va">y</span>, <span class="st">"-bar"</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Measure performance of double dispatch</span>
<span class="fu">bench</span><span class="fu">::</span><span class="fu">mark</span><span class="op">(</span><span class="fu">bar_R7</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span>, <span class="fu">bar_s4</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 2 x 6</span>
<span class="co">#&gt;   expression        min   median `itr/sec` mem_alloc `gc/sec`</span>
<span class="co">#&gt;   &lt;bch:expr&gt;   &lt;bch:tm&gt; &lt;bch:tm&gt;     &lt;dbl&gt; &lt;bch:byt&gt;    &lt;dbl&gt;</span>
<span class="co">#&gt; 1 bar_R7(x, y)  14.11µs   15.7µs    59301.        0B     29.7</span>
<span class="co">#&gt; 2 bar_s4(x, y)   9.39µs   10.8µs    85471.        0B     17.1</span></code></pre></div>
<p>A potential optimization is caching based on the class names, but lookup should be fast without this.</p>
<p>The following benchmark generates a class heiarchy of different levels and lengths of class names and compares the time to dispatch on the first class in the hiearchy vs the time to dispatch on the last class.</p>
<p>We find that even in very extreme cases (e.g. 100 deep heirachy 100 of character class names) the overhead is reasonable, and for more reasonable cases (e.g. 10 deep hiearchy of 15 character class names) the overhead is basically negligible.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://RConsortium.github.io/OOP-WG">R7</a></span><span class="op">)</span>

<span class="va">gen_character</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">n</span>, <span class="va">min</span> <span class="op">=</span> <span class="fl">5</span>, <span class="va">max</span> <span class="op">=</span> <span class="fl">25</span>, <span class="va">values</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">letters</span>, <span class="va">LETTERS</span>, <span class="fl">0</span><span class="op">:</span><span class="fl">9</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">lengths</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">min</span><span class="op">:</span><span class="va">max</span>, replace <span class="op">=</span> <span class="cn">TRUE</span>, size <span class="op">=</span> <span class="va">n</span><span class="op">)</span>
  <span class="va">values</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">values</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">lengths</span><span class="op">)</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  <span class="va">starts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html">cumsum</a></span><span class="op">(</span><span class="va">lengths</span><span class="op">)</span><span class="op">[</span><span class="op">-</span><span class="va">n</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span>
  <span class="va">ends</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html">cumsum</a></span><span class="op">(</span><span class="va">lengths</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/mapply.html">mapply</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">start</span>, <span class="va">end</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">values</span><span class="op">[</span><span class="va">start</span><span class="op">:</span><span class="va">end</span><span class="op">]</span>, collapse<span class="op">=</span><span class="st">""</span><span class="op">)</span>, <span class="va">starts</span>, <span class="va">ends</span><span class="op">)</span>
<span class="op">}</span>

<span class="fu">bench</span><span class="fu">::</span><span class="fu">press</span><span class="op">(</span>
  num_classes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">5</span>, <span class="fl">10</span>, <span class="fl">50</span>, <span class="fl">100</span><span class="op">)</span>,
  class_nchar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">15</span>, <span class="fl">100</span><span class="op">)</span>,
  <span class="op">{</span>
    <span class="co"># Construct a class hierarchy with that number of classes</span>
    <span class="va">text</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/new_class.html">new_class</a></span><span class="op">(</span><span class="st">"text"</span>, parent <span class="op">=</span> <span class="st">"character"</span>, constructor <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">text</span><span class="op">)</span> <span class="fu"><a href="reference/new_object.html">new_object</a></span><span class="op">(</span>.data <span class="op">=</span> <span class="va">text</span><span class="op">)</span><span class="op">)</span>
    <span class="va">parent</span> <span class="op">&lt;-</span> <span class="va">text</span>
    <span class="va">classes</span> <span class="op">&lt;-</span> <span class="fu">gen_character</span><span class="op">(</span><span class="va">num_classes</span>, min <span class="op">=</span> <span class="va">class_nchar</span>, max <span class="op">=</span> <span class="va">class_nchar</span><span class="op">)</span>
    <span class="va">env</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html">new.env</a></span><span class="op">(</span><span class="op">)</span>
    <span class="kw">for</span> <span class="op">(</span><span class="va">x</span> <span class="kw">in</span> <span class="va">classes</span><span class="op">)</span> <span class="op">{</span>
      <span class="fu"><a href="https://rdrr.io/r/base/assign.html">assign</a></span><span class="op">(</span><span class="va">x</span>, <span class="fu"><a href="reference/new_class.html">new_class</a></span><span class="op">(</span><span class="va">x</span>, parent <span class="op">=</span> <span class="va">parent</span>, constructor <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">text</span><span class="op">)</span> <span class="fu"><a href="reference/new_object.html">new_object</a></span><span class="op">(</span>.data <span class="op">=</span> <span class="va">text</span><span class="op">)</span><span class="op">)</span>, <span class="va">env</span><span class="op">)</span>
      <span class="va">parent</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/get.html">get</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">env</span><span class="op">)</span>
    <span class="op">}</span>

    <span class="co"># Get the last defined class</span>
    <span class="va">cls</span> <span class="op">&lt;-</span> <span class="va">parent</span>

    <span class="co"># Construct an object of that class</span>
    <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="va">cls</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"hi"</span><span class="op">)</span><span class="op">)</span>

    <span class="co"># Define a generic and a method for the last class (best case scenario)</span>
    <span class="va">foo_R7</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/new_generic.html">new_generic</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"foo_R7"</span>, signature <span class="op">=</span> <span class="st">"x"</span><span class="op">)</span>
    <span class="fu"><a href="reference/method.html">method</a></span><span class="op">(</span><span class="va">foo_R7</span>, <span class="va">cls</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"-foo"</span><span class="op">)</span>

    <span class="co"># Define a generic and a method for the first class (worst case scenario)</span>
    <span class="va">foo2_R7</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/new_generic.html">new_generic</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"foo2_R7"</span>, signature <span class="op">=</span> <span class="st">"x"</span><span class="op">)</span>
    <span class="fu"><a href="reference/method.html">method</a></span><span class="op">(</span><span class="va">foo2_R7</span>, <span class="va">R7_object</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"-foo"</span><span class="op">)</span>

    <span class="fu">bench</span><span class="fu">::</span><span class="fu">mark</span><span class="op">(</span>
      best <span class="op">=</span> <span class="fu">foo_R7</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>,
      worst <span class="op">=</span> <span class="fu">foo2_R7</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
    <span class="op">)</span>
  <span class="op">}</span>
<span class="op">)</span>
<span class="co">#&gt; # A tibble: 20 x 8</span>
<span class="co">#&gt;    expression num_classes class_nchar      min   median `itr/sec` mem_alloc `gc/sec`</span>
<span class="co">#&gt;    &lt;bch:expr&gt;       &lt;dbl&gt;       &lt;dbl&gt; &lt;bch:tm&gt; &lt;bch:tm&gt;     &lt;dbl&gt; &lt;bch:byt&gt;    &lt;dbl&gt;</span>
<span class="co">#&gt;  1 best                 3          15   8.62µs   10.9µs    91862.        0B     36.8</span>
<span class="co">#&gt;  2 worst                3          15   9.03µs   11.3µs    88546.        0B     35.4</span>
<span class="co">#&gt;  3 best                 5          15   8.84µs   10.3µs    91116.        0B     36.5</span>
<span class="co">#&gt;  4 worst                5          15   9.35µs   10.5µs    90944.        0B     36.4</span>
<span class="co">#&gt;  5 best                10          15   8.98µs   11.1µs    89742.        0B     35.9</span>
<span class="co">#&gt;  6 worst               10          15   9.65µs   11.9µs    82342.        0B     24.7</span>
<span class="co">#&gt;  7 best                50          15   9.15µs   11.4µs    87054.        0B     34.8</span>
<span class="co">#&gt;  8 worst               50          15  13.01µs   14.7µs    64879.        0B     26.0</span>
<span class="co">#&gt;  9 best               100          15   9.34µs   11.1µs    86467.        0B     34.6</span>
<span class="co">#&gt; 10 worst              100          15  17.02µs   18.8µs    50694.        0B     20.3</span>
<span class="co">#&gt; 11 best                 3         100   8.64µs   10.6µs    93073.        0B     37.2</span>
<span class="co">#&gt; 12 worst                3         100   9.36µs   11.7µs    85594.        0B     34.3</span>
<span class="co">#&gt; 13 best                 5         100   8.81µs   11.3µs    87928.        0B     35.2</span>
<span class="co">#&gt; 14 worst                5         100   9.96µs   11.8µs    82845.        0B     33.2</span>
<span class="co">#&gt; 15 best                10         100   9.05µs   11.3µs    87958.        0B     35.2</span>
<span class="co">#&gt; 16 worst               10         100  10.58µs   13.4µs    72944.        0B     21.9</span>
<span class="co">#&gt; 17 best                50         100   9.19µs   11.4µs    86818.        0B     26.1</span>
<span class="co">#&gt; 18 worst               50         100  15.89µs   17.9µs    52961.        0B     21.2</span>
<span class="co">#&gt; 19 best               100         100    9.7µs   12.3µs    81904.        0B     32.8</span>
<span class="co">#&gt; 20 worst              100         100  24.17µs   26.2µs    35199.        0B     14.1</span></code></pre></div>
<p>And the same benchmark using double-dispatch</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">bench</span><span class="fu">::</span><span class="fu">press</span><span class="op">(</span>
  num_classes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">5</span>, <span class="fl">10</span>, <span class="fl">50</span>, <span class="fl">100</span><span class="op">)</span>,
  class_nchar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">15</span>, <span class="fl">100</span><span class="op">)</span>,
  <span class="op">{</span>
    <span class="co"># Construct a class hierarchy with that number of classes</span>
    <span class="va">text</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/new_class.html">new_class</a></span><span class="op">(</span><span class="st">"text"</span>, parent <span class="op">=</span> <span class="st">"character"</span>, constructor <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">text</span><span class="op">)</span> <span class="fu"><a href="reference/new_object.html">new_object</a></span><span class="op">(</span>.data <span class="op">=</span> <span class="va">text</span><span class="op">)</span><span class="op">)</span>
    <span class="va">parent</span> <span class="op">&lt;-</span> <span class="va">text</span>
    <span class="va">classes</span> <span class="op">&lt;-</span> <span class="fu">gen_character</span><span class="op">(</span><span class="va">num_classes</span>, min <span class="op">=</span> <span class="va">class_nchar</span>, max <span class="op">=</span> <span class="va">class_nchar</span><span class="op">)</span>
    <span class="va">env</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html">new.env</a></span><span class="op">(</span><span class="op">)</span>
    <span class="kw">for</span> <span class="op">(</span><span class="va">x</span> <span class="kw">in</span> <span class="va">classes</span><span class="op">)</span> <span class="op">{</span>
      <span class="fu"><a href="https://rdrr.io/r/base/assign.html">assign</a></span><span class="op">(</span><span class="va">x</span>, <span class="fu"><a href="reference/new_class.html">new_class</a></span><span class="op">(</span><span class="va">x</span>, parent <span class="op">=</span> <span class="va">parent</span>, constructor <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">text</span><span class="op">)</span> <span class="fu"><a href="reference/new_object.html">new_object</a></span><span class="op">(</span>.data <span class="op">=</span> <span class="va">text</span><span class="op">)</span><span class="op">)</span>, <span class="va">env</span><span class="op">)</span>
      <span class="va">parent</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/get.html">get</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">env</span><span class="op">)</span>
    <span class="op">}</span>

    <span class="co"># Get the last defined class</span>
    <span class="va">cls</span> <span class="op">&lt;-</span> <span class="va">parent</span>

    <span class="co"># Construct an object of that class</span>
    <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="va">cls</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"hi"</span><span class="op">)</span><span class="op">)</span>
    <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="va">cls</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"ho"</span><span class="op">)</span><span class="op">)</span>

    <span class="co"># Define a generic and a method for the last class (best case scenario)</span>
    <span class="va">foo_R7</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/new_generic.html">new_generic</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"foo_R7"</span>, signature <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span><span class="op">)</span>
    <span class="fu"><a href="reference/method.html">method</a></span><span class="op">(</span><span class="va">foo_R7</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">cls</span>, <span class="va">cls</span><span class="op">)</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">...</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="st">"-foo"</span><span class="op">)</span>

    <span class="co"># Define a generic and a method for the first class (worst case scenario)</span>
    <span class="va">foo2_R7</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/new_generic.html">new_generic</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"foo2_R7"</span>, signature <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span><span class="op">)</span>
    <span class="fu"><a href="reference/method.html">method</a></span><span class="op">(</span><span class="va">foo2_R7</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">R7_object</span>, <span class="va">R7_object</span><span class="op">)</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">...</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="st">"-foo"</span><span class="op">)</span>

    <span class="fu">bench</span><span class="fu">::</span><span class="fu">mark</span><span class="op">(</span>
      best <span class="op">=</span> <span class="fu">foo_R7</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span>,
      worst <span class="op">=</span> <span class="fu">foo2_R7</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span>
    <span class="op">)</span>
  <span class="op">}</span>
<span class="op">)</span>
<span class="co">#&gt; # A tibble: 20 x 8</span>
<span class="co">#&gt;    expression num_classes class_nchar      min   median `itr/sec` mem_alloc `gc/sec`</span>
<span class="co">#&gt;    &lt;bch:expr&gt;       &lt;dbl&gt;       &lt;dbl&gt; &lt;bch:tm&gt; &lt;bch:tm&gt;     &lt;dbl&gt; &lt;bch:byt&gt;    &lt;dbl&gt;</span>
<span class="co">#&gt;  1 best                 3          15   9.62µs  11.72µs    81712.        0B    32.7 </span>
<span class="co">#&gt;  2 worst                3          15    9.6µs  10.32µs    91606.        0B    36.7 </span>
<span class="co">#&gt;  3 best                 5          15   9.18µs   9.77µs    97699.        0B    39.1 </span>
<span class="co">#&gt;  4 worst                5          15   9.98µs  10.74µs    90485.        0B    36.2 </span>
<span class="co">#&gt;  5 best                10          15   9.32µs  10.01µs    92839.        0B    37.2 </span>
<span class="co">#&gt;  6 worst               10          15  10.75µs   11.8µs    81703.        0B    32.7 </span>
<span class="co">#&gt;  7 best                50          15  10.21µs   11.1µs    86549.        0B    34.6 </span>
<span class="co">#&gt;  8 worst               50          15  17.12µs  18.44µs    52067.        0B    20.8 </span>
<span class="co">#&gt;  9 best               100          15  10.56µs   11.8µs    81407.        0B    32.6 </span>
<span class="co">#&gt; 10 worst              100          15  24.53µs  26.03µs    36629.        0B    14.7 </span>
<span class="co">#&gt; 11 best                 3         100   9.27µs  10.43µs    91396.        0B    45.7 </span>
<span class="co">#&gt; 12 worst                3         100  10.32µs  11.43µs    83567.        0B    33.4 </span>
<span class="co">#&gt; 13 best                 5         100   9.51µs  10.55µs    90847.        0B    36.4 </span>
<span class="co">#&gt; 14 worst                5         100  10.56µs  11.86µs    80953.        0B    32.4 </span>
<span class="co">#&gt; 15 best                10         100   9.54µs  10.64µs    88915.        0B    35.6 </span>
<span class="co">#&gt; 16 worst               10         100  12.25µs  13.61µs    70435.        0B    28.2 </span>
<span class="co">#&gt; 17 best                50         100  10.27µs  11.39µs    83964.        0B    33.6 </span>
<span class="co">#&gt; 18 worst               50         100  23.38µs  25.02µs    38013.        0B    15.2 </span>
<span class="co">#&gt; 19 best               100         100  10.85µs   11.8µs    80367.        0B    32.2 </span>
<span class="co">#&gt; 20 worst              100         100  37.28µs  38.79µs    24552.        0B     9.82</span></code></pre></div>
</div>
<div id="questions" class="section level2">
<h2 class="hasAnchor">
<a href="#questions" class="anchor"></a>Questions</h2>
<ul>
<li>What should happen if you call <code><a href="reference/method.html">new_method()</a></code> on a S3 generic?
<ol>
<li>Should we create a new R7 generic out of the S3 generic?</li>
<li>Or just register the R7 object using <code><a href="https://rdrr.io/r/base/ns-internal.html">registerS3method()</a></code>?</li>
</ol>
</li>
</ul>
</div>
<div id="design-workflow" class="section level2">
<h2 class="hasAnchor">
<a href="#design-workflow" class="anchor"></a>Design workflow</h2>
<ul>
<li>File an issue to discuss the topic and build consensus.</li>
<li>Once consensus has been reached, the issue author should create a pull request that summarises the discussion in the appropriate <code>.md</code> file, and request review from all folks who participated the issue discussion.</li>
<li>Once all participants have accepted the PR, the original author merges.</li>
</ul>
</div>
<div id="todo" class="section level2">
<h2 class="hasAnchor">
<a href="#todo" class="anchor"></a>TODO</h2>
<ul>
<li>Objects
<ul>
<li>
<input type="checkbox" disabled checked>
- A class object attribute, a reference to the class object, and retrieved with <code><a href="reference/object_class.html">object_class()</a></code>.</li>
<li>
<input type="checkbox" disabled checked>
- For S3 compatibility, a class attribute, a character vector of class names.</li>
<li>
<input type="checkbox" disabled checked>
- Additional attributes storing properties defined by the class, accessible with <code>@/property()</code>.</li>
</ul>
</li>
<li>Classes
<ul>
<li>
<input type="checkbox" disabled checked>
- R7 classes are first class objects with the following<ul>
<li>
<input type="checkbox" disabled checked>
- <code>name</code>, a human-meaningful descriptor for the class.</li>
<li>
<input type="checkbox" disabled checked>
- <code>parent</code>, the class object of the parent class.</li>
<li>
<input type="checkbox" disabled checked>
- A constructor, an user-facing function used to create new objects of this class. It always ends with a call to <code><a href="reference/new_object.html">new_object()</a></code> to initialize the class.</li>
<li>
<input type="checkbox" disabled checked>
- A validator, a function that takes the object and returns NULL if the object is valid, otherwise a character vector of error messages.</li>
<li>
<input type="checkbox" disabled checked>
- properties, a list of property objects</li>
</ul>
</li>
</ul>
</li>
<li>Initialization
<ul>
<li>
<input type="checkbox" disabled checked>
- The constructor uses <code><a href="reference/new_object.html">new_object()</a></code> to initialize a new object, this<ul>
<li>
<input type="checkbox" disabled checked>
- Inspects the enclosing scope to find the “current” class.</li>
<li>
<input type="checkbox" disabled>
- Creates the prototype, by either by calling the parent constructor or by creating a base type and adding class and <code><a href="reference/object_class.html">object_class()</a></code> attributes to it.</li>
<li>
<input type="checkbox" disabled checked>
- Validates properties then adds to prototype.</li>
<li>
<input type="checkbox" disabled checked>
- Validates the complete object.</li>
</ul>
</li>
</ul>
</li>
<li>Shortcuts
<ul>
<li>
<input type="checkbox" disabled>
- any argument that takes a class object can instead take the name of a class object as a string</li>
<li>
<input type="checkbox" disabled checked>
- instead of providing a list of property objects, you can instead provide a named character vector.</li>
</ul>
</li>
<li>Validation
<ul>
<li>
<input type="checkbox" disabled checked>
- valid_eventually</li>
<li>
<input type="checkbox" disabled checked>
- valid_implicitly</li>
</ul>
</li>
<li>Unions
<ul>
<li>
<input type="checkbox" disabled checked>
- Used in properties to allow a property to be one of a set of classes</li>
<li>
<input type="checkbox" disabled checked>
- In method dispatch as a convenience for defining a method for multiple classes</li>
</ul>
</li>
<li>Properties
<ul>
<li>
<input type="checkbox" disabled checked>
- Accessed using <code><a href="reference/property.html">property()</a></code> / <code>property&lt;-</code>
</li>
<li>
<input type="checkbox" disabled checked>
- Accessed using <code><a href="reference/property.html">@</a></code> / <code>@&lt;-</code>
</li>
<li>
<input type="checkbox" disabled checked>
- A name, used to label output</li>
<li>
<input type="checkbox" disabled checked>
- A optional class or union</li>
<li>
<input type="checkbox" disabled checked>
- An optional accessor functions, both getter and setters</li>
<li>
<input type="checkbox" disabled checked>
- Properties are created with <code><a href="reference/new_property.html">new_property()</a></code>
</li>
</ul>
</li>
<li>Generics
<ul>
<li>
<input type="checkbox" disabled checked>
- It knows its name and the names of the arguments in its signature</li>
<li>
<input type="checkbox" disabled checked>
- Calling <code><a href="reference/new_generic.html">new_generic()</a></code> defines a new generic</li>
<li>
<input type="checkbox" disabled>
- By convention, any argument that takes a generic function, can instead take the name of a generic function supplied as a string</li>
</ul>
</li>
<li>Methods
<ul>
<li>Registration
<ul>
<li>
<input type="checkbox" disabled checked>
- Methods are defined by calling method&lt;-(generic, signature, method):</li>
<li>
<input type="checkbox" disabled checked>
- generic is a generic function.</li>
<li>
<input type="checkbox" disabled checked>
- signature is a<ul>
<li>
<input type="checkbox" disabled checked>
- single class object</li>
<li>
<input type="checkbox" disabled checked>
- a class union</li>
<li>
<input type="checkbox" disabled checked>
- list of class objects/unions</li>
<li>
<input type="checkbox" disabled checked>
- a character vector.</li>
</ul>
</li>
<li>
<input type="checkbox" disabled checked>
- method is a compatible function</li>
<li>
<input type="checkbox" disabled checked>
- <code>new_method</code> is designed to work at run-time<ul>
<li>
<input type="checkbox" disabled checked>
- <code>new_method</code> should optionally take a package version, so the method is only registered if the package is newer than the version.</li>
</ul>
</li>
<li>
<input type="checkbox" disabled>
- Can define methods where one of the arguments is missing</li>
<li>
<input type="checkbox" disabled>
- Can define methods where one of the arguments has any type</li>
</ul>
</li>
<li>Dispatch
<ul>
<li>
<input type="checkbox" disabled checked>
- Dispatch is nested, meaning that if there are multiple arguments in the generic signature, it will dispatch on the first argument, then the second.</li>
<li>
<input type="checkbox" disabled checked>
- A <code><a href="https://rdrr.io/r/graphics/plot.default.html">plot()</a></code> generic dispatching on <code>x</code>, e.g. <code>plot &lt;- function(x) { method(plot, object_class(x))(x) }</code>
</li>
<li>
<input type="checkbox" disabled checked>
- A <code>publish()</code> that publishes an object <code>x</code> to a destination <code>y</code>, dispatching on both arguments, e.g. <code>publish &lt;- function(x, y, ...) { method(publish, list(object_class(x), object_class(y)))(x, y, ...) }</code>
</li>
<li>
<input type="checkbox" disabled checked>
- <code>...</code> is not used for dispatch</li>
<li>
<input type="checkbox" disabled checked>
- R7 generics can dispatch with base type objects</li>
<li>
<input type="checkbox" disabled checked>
- R7 generics can dispatch with S3 objects</li>
<li>
<input type="checkbox" disabled checked>
- R7 generics can dispatch with S4 objects</li>
<li>
<input type="checkbox" disabled checked>
- <code><a href="reference/next_method.html">next_method()</a></code> can dispatch on multiple arguments, avoiding methods that have already been called.</li>
<li>
<input type="checkbox" disabled checked>
- Generics forward promises to methods, so methods can use non-standard evaluation.</li>
</ul>
</li>
</ul>
</li>
<li>Compatibility
<ul>
<li>S3
<ul>
<li>
<input type="checkbox" disabled checked>
- Since the class attribute has the same semantics as S3, S3 dispatch should be fully compatible.</li>
<li>
<input type="checkbox" disabled checked>
- The new generics should also be able to handle legacy S3 objects.</li>
<li>
<input type="checkbox" disabled checked>
- <code><a href="reference/method.html">method()</a></code> falls back to single argument S3 dispatch if the R7 dispatch fails.</li>
<li>
<input type="checkbox" disabled>
- <code><a href="reference/method.html">method()</a></code> uses S3 group generics as well</li>
</ul>
</li>
<li>S4
<ul>
<li>
<input type="checkbox" disabled checked>
- Since the new generics will fallback to S3 dispatch, they should support S4 objects just as S3 generics support them now.</li>
</ul>
</li>
</ul>
</li>
<li>Documentation
<ul>
<li>
<input type="checkbox" disabled>
- Generate index pages that list the methods for a generic or the methods with a particular class in their signature</li>
</ul>
</li>
</ul>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <div class="license">
<h2>License</h2>
<ul class="list-unstyled">
<li><a href="LICENSE.html">Full license</a></li>
<li><small><a href="https://opensource.org/licenses/mit-license.php">MIT</a> + file <a href="LICENSE-text.html">LICENSE</a></small></li>
</ul>
</div>
<div class="developers">
<h2>Developers</h2>
<ul class="list-unstyled">
<li>Henrik Bengtsson <br><small class="roles"> Author </small>  </li>
<li>Will Landau <br><small class="roles"> Author </small>  </li>
<li>Michael Lawrence <br><small class="roles"> Author </small>  </li>
<li>Martin Maechler <br><small class="roles"> Author </small>  </li>
<li>Luke Tierney <br><small class="roles"> Author </small>  </li>
<li>Gabriela De Queiroz <br><small class="roles"> Author </small>  </li>
<li>
<a href="http://hadley.nz">Hadley Wickham</a> <br><small class="roles"> Author </small>  </li>
<li>Jim Hester <br><small class="roles"> Author, maintainer </small> <a href="https://orcid.org/0000-0002-2739-7082" target="orcid.widget" aria-label="ORCID"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a> </li>
</ul>
</div>

  </div>
</div>


      <footer><div class="copyright">
  <p>Developed by Henrik Bengtsson, Will Landau, Michael Lawrence, Martin Maechler, Luke Tierney, Gabriela De Queiroz, <a href="http://hadley.nz">Hadley Wickham</a>, Jim Hester.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
